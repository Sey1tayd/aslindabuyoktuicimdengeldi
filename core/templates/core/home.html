{% extends 'core/base.html' %}
{% load static %}

{% block title %}Sarac Ä°hsan â€“ At EkipmanlarÄ± ve KoÅŸum TakÄ±mlarÄ±{% endblock %}

{% block extra_head %}
{% endblock %}

{% block content %}
<main id="content" role="main">

    <!-- ============ HERO CAROUSEL WITH 3D MODELS ============ -->
    <div class="carousel" id="showcaseCarousel">
      <div class="list">
        {% if showcase_models %}
          {% for sc in showcase_models %}
            <div class="item" 
                 data-embed="{{ sc.get_sketchfab_embed_url|default_if_none:'' }}"
                 data-title="{{ sc.title|escape }}">
              <div class="introduce">
                <div class="title">{{ sc.title }}</div>
                <div class="topic">{{ sc.topic|linebreaksbr }}</div>
                <div class="des">{{ sc.description }}</div>
                <button class="seeMore" onclick="location.href='{{ sc.button_url }}'">
                  {{ sc.button_text }} &#8599
                </button>
              </div>

              <!-- Poster (hafif gÃ¶rsel); category gÃ¶rselin, logo ya da Ã¶zel poster koy -->
              <div class="model-slot">
                <div class="model-poster"></div>
                <!-- JS burada aktif slayt olunca iframe'i ekleyecek -->
              </div>

              {% if sc.badge_text %}<div class="badge">{{ sc.badge_text|upper|linebreaksbr }}</div>{% endif %}
            </div>
          {% endfor %}
        {% else %}
          <!-- Fallback: EÄŸer admin'den model yÃ¼klenmemiÅŸse eski modeller gÃ¶sterilir -->
          <div class="item">
            <div class="introduce">
              <div class="title">Ã–ZEL KOLEKSÄ°YON</div>
              <div class="topic">Kalite<br>ve GÃ¼ven</div>
              <div class="des">At ekipmanlarÄ±nda premium seÃ§imler.</div>
              <button class="seeMore">KEÅžFET &#8599</button>
            </div>
            <div class="model-slot"><div class="model-poster"></div></div>
            <div class="badge">KALÄ°TE<br>GÃœVENCE</div>
          </div>
        {% endif %}
      </div>

      <div class="arrows">
        <button id="prev">â€¹</button>
        <button id="next">â€º</button>
      </div>
    </div>

    <!-- ============ FEATURED PRODUCTS CAROUSEL ============ -->
    <section class="section section--featured-products">
      <div class="container">
        <div class="section__head">
          <h2>Ã–ne Ã‡Ä±kan ÃœrÃ¼nler</h2>
        </div>
        <div class="featured-products-carousel" id="featuredCarousel">
          <div class="featured-products-track">
            {% if featured_products_static %}
              {% for product in featured_products_static %}
                <div class="featured-product-item">
                  <a href="{% url 'core:product_detail' product_name=product.name|urlencode %}" class="featured-product-link">
                    <div class="featured-product-image" style="background-image: url('{% static product.path %}');"></div>
                    <div class="featured-product-name">
                      {% if "." in product.name %}
                        {% with name=product.name|slice:":-4" %}
                          {{ name|title }}
                        {% endwith %}
                      {% else %}
                        {{ product.name|title }}
                      {% endif %}
                    </div>
                  </a>
                </div>
              {% endfor %}
              <!-- Duplicate items for seamless loop -->
              {% for product in featured_products_static %}
                <div class="featured-product-item">
                  <a href="{% url 'core:product_detail' product_name=product.name|urlencode %}" class="featured-product-link">
                    <div class="featured-product-image" style="background-image: url('{% static product.path %}');"></div>
                    <div class="featured-product-name">
                      {% if "." in product.name %}
                        {% with name=product.name|slice:":-4" %}
                          {{ name|title }}
                        {% endwith %}
                      {% else %}
                        {{ product.name|title }}
                      {% endif %}
                    </div>
                  </a>
                </div>
              {% endfor %}
            {% else %}
              <!-- Placeholder items when no products -->
              {% for i in "12345678901234567890" %}
                <div class="featured-product-item">
                  <div class="featured-product-link featured-product-placeholder">
                    <div class="featured-product-image featured-product-image-placeholder">
                      <span class="placeholder-icon">ðŸ“¦</span>
                    </div>
                    <div class="featured-product-name featured-product-name-placeholder">
                      ÃœrÃ¼n Eklenecek
                    </div>
                  </div>
                </div>
              {% endfor %}
            {% endif %}
          </div>
        </div>
      </div>
    </section>

    <!-- ============ SHOP BY CATEGORY ============ -->
    <section class="section section--categories">
      <div class="container">
        <div class="section__head">
          <h2>Kategoriler</h2>
          <p>Ä°htiyacÄ±nÄ±za uygun kategoriyi seÃ§in ve geniÅŸ Ã¼rÃ¼n yelpazemizi keÅŸfedin</p>
        </div>

        <div class="categories-grid" role="list">
          {% if categories_with_mapping %}
            {% for cat_data in categories_with_mapping %}
              {% with category=cat_data.category mapping=cat_data.mapping %}
                {% if mapping.use_media_image and category.image %}
                  {% if forloop.counter == 1 %}
                    <!-- Ä°lk satÄ±r: Sol bÃ¼yÃ¼k kategori -->
                    <a class="cat cat--large cat--row1-left {{ mapping.css_class }}" role="listitem" href="{% url 'core:category_detail' category.slug %}" style="background-image: url('{{ category.image.url }}');">
                      <span class="cat__overlay"></span>
                      <span class="cat__name">{{ category.name }}</span>
                    </a>
                  {% elif forloop.counter == 2 or forloop.counter == 3 %}
                    <!-- Ä°lk satÄ±r: SaÄŸ kÃ¼Ã§Ã¼k kategoriler -->
                    <a class="cat cat--small {{ mapping.css_class }}" role="listitem" href="{% url 'core:category_detail' category.slug %}" style="background-image: url('{{ category.image.url }}');">
                      <span class="cat__overlay"></span>
                      <span class="cat__name">{{ category.name }}</span>
                    </a>
                  {% elif forloop.counter == 4 or forloop.counter == 5 %}
                    <!-- Ä°kinci satÄ±r: Sol kÃ¼Ã§Ã¼k kategoriler -->
                    <a class="cat cat--small {{ mapping.css_class }}" role="listitem" href="{% url 'core:category_detail' category.slug %}" style="background-image: url('{{ category.image.url }}');">
                      <span class="cat__overlay"></span>
                      <span class="cat__name">{{ category.name }}</span>
                    </a>
                  {% elif forloop.counter == 6 %}
                    <!-- Ä°kinci satÄ±r: SaÄŸ bÃ¼yÃ¼k kategori -->
                    <a class="cat cat--large cat--row2-right {{ mapping.css_class }}" role="listitem" href="{% url 'core:category_detail' category.slug %}" style="background-image: url('{{ category.image.url }}');">
                      <span class="cat__overlay"></span>
                      <span class="cat__name">{{ category.name }}</span>
                    </a>
                  {% else %}
                    <!-- Ekstra kategoriler varsa kÃ¼Ã§Ã¼k olarak ekle -->
                    <a class="cat cat--small {{ mapping.css_class }}" role="listitem" href="{% url 'core:category_detail' category.slug %}" style="background-image: url('{{ category.image.url }}');">
                      <span class="cat__overlay"></span>
                      <span class="cat__name">{{ category.name }}</span>
                    </a>
                  {% endif %}
                {% else %}
                  {% if forloop.counter == 1 %}
                    <!-- Ä°lk satÄ±r: Sol bÃ¼yÃ¼k kategori -->
                    <a class="cat cat--large cat--row1-left {{ mapping.css_class }}" role="listitem" href="{% url 'core:category_detail' category.slug %}" style="background-image: url('{% static 'images/categories/'|add:mapping.image %}');">
                      <span class="cat__overlay"></span>
                      <span class="cat__name">{{ category.name }}</span>
                    </a>
                  {% elif forloop.counter == 2 or forloop.counter == 3 %}
                    <!-- Ä°lk satÄ±r: SaÄŸ kÃ¼Ã§Ã¼k kategoriler -->
                    <a class="cat cat--small {{ mapping.css_class }}" role="listitem" href="{% url 'core:category_detail' category.slug %}" style="background-image: url('{% static 'images/categories/'|add:mapping.image %}');">
                      <span class="cat__overlay"></span>
                      <span class="cat__name">{{ category.name }}</span>
                    </a>
                  {% elif forloop.counter == 4 or forloop.counter == 5 %}
                    <!-- Ä°kinci satÄ±r: Sol kÃ¼Ã§Ã¼k kategoriler -->
                    <a class="cat cat--small {{ mapping.css_class }}" role="listitem" href="{% url 'core:category_detail' category.slug %}" style="background-image: url('{% static 'images/categories/'|add:mapping.image %}');">
                      <span class="cat__overlay"></span>
                      <span class="cat__name">{{ category.name }}</span>
                    </a>
                  {% elif forloop.counter == 6 %}
                    <!-- Ä°kinci satÄ±r: SaÄŸ bÃ¼yÃ¼k kategori -->
                    <a class="cat cat--large cat--row2-right {{ mapping.css_class }}" role="listitem" href="{% url 'core:category_detail' category.slug %}" style="background-image: url('{% static 'images/categories/'|add:mapping.image %}');">
                      <span class="cat__overlay"></span>
                      <span class="cat__name">{{ category.name }}</span>
                    </a>
                  {% else %}
                    <!-- Ekstra kategoriler varsa kÃ¼Ã§Ã¼k olarak ekle -->
                    <a class="cat cat--small {{ mapping.css_class }}" role="listitem" href="{% url 'core:category_detail' category.slug %}" style="background-image: url('{% static 'images/categories/'|add:mapping.image %}');">
                      <span class="cat__overlay"></span>
                      <span class="cat__name">{{ category.name }}</span>
                    </a>
                  {% endif %}
                {% endif %}
              {% endwith %}
            {% endfor %}
          {% else %}
            <!-- Fallback kategoriler -->
            <a class="cat cat--large cat--row1-left cat--racing" role="listitem" href="{% url 'core:category_list' %}" style="background-image: url('{% static 'images/categories/kosum-takimi.jpg' %}');">
              <span class="cat__overlay"></span>
              <span class="cat__name">At KoÅŸu EkipmanlarÄ±</span>
            </a>
            <a class="cat cat--small cat--grooming" role="listitem" href="{% url 'core:category_list' %}" style="background-image: url('{% static 'images/categories/timar.jpg' %}');">
              <span class="cat__overlay"></span>
              <span class="cat__name">TÄ±mar EkipmanlarÄ±</span>
            </a>
            <a class="cat cat--small cat--care" role="listitem" href="{% url 'core:category_list' %}" style="background-image: url('{% static 'images/categories/bakim.jpg' %}');">
              <span class="cat__overlay"></span>
              <span class="cat__name">At BakÄ±m EkipmanlarÄ±</span>
            </a>
            <a class="cat cat--small cat--farrier" role="listitem" href="{% url 'core:category_list' %}" style="background-image: url('{% static 'images/categories/nalbant.jpg' %}');">
              <span class="cat__overlay"></span>
              <span class="cat__name">Nalbant EkipmanlarÄ±</span>
            </a>
            <a class="cat cat--small cat--rider" role="listitem" href="{% url 'core:category_list' %}" style="background-image: url('{% static 'images/categories/binici.jpg' %}');">
              <span class="cat__overlay"></span>
              <span class="cat__name">Binici EkipmanlarÄ±</span>
            </a>
            <a class="cat cat--large cat--row2-right cat--carriage" role="listitem" href="{% url 'core:category_list' %}" style="background-image: url('{% static 'images/categories/eyer.jpg' %}');">
              <span class="cat__overlay"></span>
              <span class="cat__name">Araba ve Fayton TakÄ±mÄ±</span>
            </a>
          {% endif %}
        </div>
      </div>
    </section>

    <!-- ============ CATEGORY PRODUCTS ============ -->
    {% if categories_with_mapping %}
      {% for cat_data in categories_with_mapping %}
        {% with category=cat_data.category mapping=cat_data.mapping %}
          {% if category_with_products %}
            {% for category_name, products in category_with_products.items %}
              {% if category_name == category.name %}
                {% if products %}
                  <section class="section section--category-products">
                    <div class="container">
                      <div class="category-products__header">
                        <h3 class="category-products__title">{{ category.name }}</h3>
                        <a href="{% url 'core:category_detail' category.slug %}" class="category-products__link">TÃ¼mÃ¼nÃ¼ GÃ¶r â†’</a>
                      </div>
                      <div class="grid grid--category-products" role="list">
                        {% for product in products|slice:":8" %}
                          <article class="category-product" role="listitem">
                            <a class="category-product__media" href="{% url 'core:product_detail' product_name=product.name|urlencode %}">
                              <div class="category-product__img" style="background-image: url('{% static product.path %}'); background-size: cover; background-position: center;"></div>
                            </a>
                            <div class="category-product__meta">
                              <h4 class="category-product__title">
                                <a href="{% url 'core:product_detail' product_name=product.name|urlencode %}">
                                  {% if "." in product.name %}
                                    {% with name=product.name|slice:":-4" %}
                                      {{ name|title }}
                                    {% endwith %}
                                  {% else %}
                                    {{ product.name|title }}
                                  {% endif %}
                                </a>
                              </h4>
                            </div>
                          </article>
                        {% endfor %}
                      </div>
                    </div>
                  </section>
                {% endif %}
              {% endif %}
            {% endfor %}
          {% endif %}
        {% endwith %}
      {% endfor %}
    {% endif %}

  </main>
{% endblock %}

{% block extra_scripts %}
  <!-- Showcase Carousel Script (Tek Viewer - Performans OdaklÄ±) -->
  <script>
    (function() {
      const root = document.getElementById('showcaseCarousel');
      const list = root.querySelector('.list');
      const prev = root.querySelector('#prev');
      const next = root.querySelector('#next');

      let unacceptClick;
      let activeIframe = null;     // tek aktif iframe
      let activeSlot = null;       // aktif item'Ä±n .model-slot'u
      let autoSlide;

      // Sketchfab viewer'Ä± yalnÄ±zca aktif karta kur
      function mountSketchfab(item) {
        const embed = item.getAttribute('data-embed');
        const slot = item.querySelector('.model-slot');
        if (!embed || !slot) return;

        // varsa eski iframe'i sÃ¶k
        unmountSketchfab();

        // Mobil cihaz kontrolÃ¼
        const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || window.innerWidth <= 768;
        
        const iframe = document.createElement('iframe');
        iframe.setAttribute('title', item.getAttribute('data-title') || '3D');
        iframe.setAttribute('frameborder', '0');
        iframe.setAttribute('allow', 'autoplay; fullscreen; xr-spatial-tracking');
        iframe.setAttribute('loading', 'eager');   // aktif slayt iÃ§in eager
        iframe.setAttribute('referrerpolicy', 'no-referrer');
        iframe.setAttribute('allowfullscreen', ''); // fullscreen izni
        iframe.style.width = '100%';
        iframe.style.height = '100%';
        iframe.style.border = '0';
        // Mobil iÃ§in kritik ayarlar
        if (isMobile) {
          iframe.style.touchAction = 'pan-x pan-y pinch-zoom';
          iframe.style.webkitTouchCallout = 'none';
          iframe.style.webkitUserSelect = 'none';
          iframe.style.userSelect = 'none';
          iframe.style.transform = 'translateZ(0)';
          iframe.style.willChange = 'transform';
          iframe.style.overscrollBehavior = 'contain';
          iframe.style.pointerEvents = 'auto';
        } else {
          iframe.style.touchAction = 'none';
          iframe.style.cursor = 'grab';
        }
        iframe.src = embed;

        slot.appendChild(iframe);
        activeIframe = iframe;
        activeSlot = slot;
      }

      function unmountSketchfab() {
        if (activeIframe && activeIframe.parentNode) {
          // iframe'i tamamen kaldÄ±r (CPU/GPU serbest kalÄ±r)
          activeIframe.parentNode.removeChild(activeIframe);
        }
        activeIframe = null;
        activeSlot = null;
      }


      // Otomatik geÃ§iÅŸ kaldÄ±rÄ±ldÄ± - sadece manuel butonlar Ã§alÄ±ÅŸacak
      function startAuto() {
        // Otomatik geÃ§iÅŸ devre dÄ±ÅŸÄ± - kullanÄ±cÄ± sadece butonlarla kontrol edebilir
        clearInterval(autoSlide);
        // autoSlide = setInterval(() => show('next'), 6000); // YORUM SATIRI: Otomatik geÃ§iÅŸ kapalÄ±
      }
      function stopAuto() {
        clearInterval(autoSlide);
      }
      
      // Global showcase timer kontrolÃ¼
      window.showcaseAuto = window.showcaseAuto || {};
      if (window.showcaseAuto.timer) {
        clearInterval(window.showcaseAuto.timer);
        window.showcaseAuto.timer = null;
      }

      function show(type) {
        prev.style.pointerEvents = 'none';
        next.style.pointerEvents = 'none';
        root.classList.remove('next','prev');

        const items = list.querySelectorAll('.item');

        if (type === 'next') {
          list.appendChild(items[0]);
          root.classList.add('next');
        } else {
          list.prepend(items[items.length - 1]);
          root.classList.add('prev');
        }

        // 1) aktif olan ikinci Ã§ocuk (orta kart)
        const newActive = list.querySelector('.item:nth-child(2)');
        // 2) yeni aktif karta viewer kur
        requestAnimationFrame(() => {
          unmountSketchfab();
          mountSketchfab(newActive);
        });

        clearTimeout(unacceptClick);
        unacceptClick = setTimeout(() => {
          prev.style.pointerEvents = 'auto';
          next.style.pointerEvents = 'auto';
          // startAuto(); // Otomatik geÃ§iÅŸ kapalÄ± - kaldÄ±rÄ±ldÄ±
        }, 2000); // Airpods style: 2s bekleme sÃ¼resi animasyonlar iÃ§in
      }

      next.addEventListener('click', () => show('next'));
      prev.addEventListener('click', () => show('prev'));
      // list.addEventListener('mouseenter', stopAuto); // Otomatik geÃ§iÅŸ kapalÄ±
      // list.addEventListener('mouseleave', startAuto); // Otomatik geÃ§iÅŸ kapalÄ±

      // init
      const firstActive = list.querySelector('.item:nth-child(2)') || list.firstElementChild;
      if (firstActive) mountSketchfab(firstActive);
      // startAuto(); // Otomatik geÃ§iÅŸ kapalÄ± - kaldÄ±rÄ±ldÄ±

      // Sayfa gÃ¶rÃ¼nÃ¼rlÃ¼k deÄŸiÅŸince GPU yÃ¼kÃ¼nÃ¼ kes
      document.addEventListener('visibilitychange', () => {
        if (document.hidden) {
          stopAuto();
          unmountSketchfab();
        } else {
          const a = list.querySelector('.item:nth-child(2)') || list.firstElementChild;
          if (a) mountSketchfab(a);
          // startAuto(); // Otomatik geÃ§iÅŸ kapalÄ± - kaldÄ±rÄ±ldÄ±
        }
      });

      // KullanÄ±cÄ± "az animasyon" istiyorsa (eriÅŸilebilirlik)
      const prm = window.matchMedia('(prefers-reduced-motion: reduce)');
      if (prm.matches) stopAuto();
    })();
  </script>

  <!-- Featured Products Blur Script -->
  <script>
    function updateFeaturedProductsBlur() {
      const carousel = document.getElementById('featuredCarousel');
      if (!carousel) return;
      
      const items = carousel.querySelectorAll('.featured-product-item');
      const carouselRect = carousel.getBoundingClientRect();
      const carouselLeft = carouselRect.left;
      const carouselRight = carouselRect.right;
      const blurZone = 150; // Blur baÅŸlangÄ±Ã§ mesafesi
      
      items.forEach(item => {
        const itemRect = item.getBoundingClientRect();
        const itemLeft = itemRect.left;
        const itemRight = itemRect.right;
        const itemCenter = itemLeft + (itemRect.width / 2);
        
        // Sol kenara yakÄ±nlÄ±k
        const distanceFromLeft = itemCenter - carouselLeft;
        // SaÄŸ kenara yakÄ±nlÄ±k
        const distanceFromRight = carouselRight - itemCenter;
        
        let blurAmount = 0;
        let opacity = 1;
        
        if (distanceFromLeft < blurZone) {
          blurAmount = (blurZone - distanceFromLeft) / blurZone * 8;
          opacity = 0.3 + (distanceFromLeft / blurZone) * 0.7;
        } else if (distanceFromRight < blurZone) {
          blurAmount = (blurZone - distanceFromRight) / blurZone * 8;
          opacity = 0.3 + (distanceFromRight / blurZone) * 0.7;
        }
        
        const image = item.querySelector('.featured-product-image');
        if (image) {
          image.style.filter = `blur(${blurAmount}px)`;
          image.style.opacity = opacity;
        }
      });
    }
    
    // Scroll ve animasyon sÄ±rasÄ±nda blur gÃ¼ncelle
    let blurUpdateInterval;
    
    function startBlurUpdates() {
      updateFeaturedProductsBlur();
      blurUpdateInterval = setInterval(updateFeaturedProductsBlur, 100);
    }
    
    function stopBlurUpdates() {
      if (blurUpdateInterval) {
        clearInterval(blurUpdateInterval);
      }
    }
    
    window.addEventListener('DOMContentLoaded', function() {
      startBlurUpdates();
      
      // Carousel hover durumunda da Ã§alÄ±ÅŸsÄ±n
      const featuredCarousel = document.getElementById('featuredCarousel');
      if (featuredCarousel) {
        featuredCarousel.addEventListener('mouseenter', startBlurUpdates);
        featuredCarousel.addEventListener('mouseleave', startBlurUpdates);
      }
    });
  </script>
{% endblock %}
