{% extends 'core/base.html' %}
{% load static %}

{% block title %}Sarac İhsan – At Ekipmanları ve Koşum Takımları{% endblock %}

{% block extra_head %}
  <script type="module" src="https://ajax.googleapis.com/ajax/libs/model-viewer/3.3.0/model-viewer.min.js"></script>
{% endblock %}

{% block content %}
<main id="content" role="main">

    <!-- ============ HERO CAROUSEL WITH 3D MODELS ============ -->
    <div class="carousel">
      <div class="list">
        {% if showcase_models %}
          {% for showcase in showcase_models %}
            <div class="item">
              <div class="introduce">
                <div class="title">{{ showcase.title }}</div>
                <div class="topic">{{ showcase.topic|linebreaksbr }}</div>
                <div class="des">{{ showcase.description }}</div>
                <button class="seeMore" onclick="window.location.href='{{ showcase.button_url }}'">{{ showcase.button_text }} &#8599</button>
              </div>
              {% if showcase.is_sketchfab %}
                <div class="sketchfab-embed-wrapper" style="width: 100%; height: 100%; position: relative;">
                  <iframe 
                    title="{{ showcase.title }}" 
                    frameborder="0" 
                    allowfullscreen 
                    mozallowfullscreen="true" 
                    webkitallowfullscreen="true" 
                    allow="autoplay; fullscreen; xr-spatial-tracking" 
                    xr-spatial-tracking 
                    execution-while-out-of-viewport 
                    execution-while-not-rendered 
                    web-share 
                    src="{{ showcase.get_sketchfab_embed_url }}"
                    style="width: 100%; height: 100%; border: none;">
                  </iframe>
                </div>
              {% elif showcase.get_model_url %}
                <model-viewer 
                  src="{{ showcase.get_model_url }}" 
                  alt="{{ showcase.topic }}" 
                  camera-controls 
                  shadow-intensity="1"
                  exposure="1"
                  environment-image="neutral"
                  ar-modes="none"
                  loading="lazy"
                  preload="auto"
                  auto-rotate
                  auto-rotate-delay="0"
                  interaction-policy="allow-when-focused"
                  interaction-prompt-threshold="0"
                  skybox-image=""
                  crossorigin="anonymous"
                  min-camera-orbit="auto auto auto"
                  max-camera-orbit="auto auto auto"
                  field-of-view="45deg">
                </model-viewer>
              {% endif %}
              {% if showcase.badge_text %}
                <div class="badge">{{ showcase.badge_text|upper|linebreaksbr }}</div>
              {% endif %}
            </div>
          {% endfor %}
        {% else %}
          <!-- Fallback: Eğer admin'den model yüklenmemişse eski modeller gösterilir -->
          <!-- Item 1 -->
          <div class="item">
            <div class="introduce">
              <div class="title">ÖZEL KOLEKSİYON</div>
              <div class="topic">Kalite<br>ve Güven</div>
              <div class="des">At ekipmanları ve koşum takımları konusunda yılların deneyimi ile kaliteli ürünler sunuyoruz.</div>
              <button class="seeMore">KEŞFET &#8599</button>
            </div>
            <model-viewer 
              src="/media/showcase/model.glb" 
              alt="3D Model" 
              camera-controls 
              shadow-intensity="1"
              exposure="1"
              environment-image="neutral"
              ar-modes="none"
              loading="lazy"
              preload="auto"
              auto-rotate
              auto-rotate-delay="0"
              interaction-policy="allow-when-focused"
              interaction-prompt-threshold="0"
              skybox-image=""
              crossorigin="anonymous"
              min-camera-orbit="auto auto auto"
              max-camera-orbit="auto auto auto"
              field-of-view="45deg">
            </model-viewer>
            <div class="badge">KALİTE<br>GÜVENCE</div>
          </div>
        {% endif %}
      </div>
      <div class="arrows">
        <button id="prev">‹</button>
        <button id="next">›</button>
      </div>
    </div>

    <!-- ============ FEATURED PRODUCTS CAROUSEL ============ -->
    <section class="section section--featured-products">
      <div class="container">
        <div class="section__head">
          <h2>Öne Çıkan Ürünler</h2>
        </div>
        <div class="featured-products-carousel" id="featuredCarousel">
          <div class="featured-products-track">
            {% if featured_products_static %}
              {% for product in featured_products_static %}
                <div class="featured-product-item">
                  <a href="{% url 'core:product_detail' product_name=product.name|urlencode %}" class="featured-product-link">
                    <div class="featured-product-image" style="background-image: url('{% static product.path %}');"></div>
                    <div class="featured-product-name">
                      {% if "." in product.name %}
                        {% with name=product.name|slice:":-4" %}
                          {{ name|title }}
                        {% endwith %}
                      {% else %}
                        {{ product.name|title }}
                      {% endif %}
                    </div>
                  </a>
                </div>
              {% endfor %}
              <!-- Duplicate items for seamless loop -->
              {% for product in featured_products_static %}
                <div class="featured-product-item">
                  <a href="{% url 'core:product_detail' product_name=product.name|urlencode %}" class="featured-product-link">
                    <div class="featured-product-image" style="background-image: url('{% static product.path %}');"></div>
                    <div class="featured-product-name">
                      {% if "." in product.name %}
                        {% with name=product.name|slice:":-4" %}
                          {{ name|title }}
                        {% endwith %}
                      {% else %}
                        {{ product.name|title }}
                      {% endif %}
                    </div>
                  </a>
                </div>
              {% endfor %}
            {% else %}
              <!-- Placeholder items when no products -->
              {% for i in "12345678901234567890" %}
                <div class="featured-product-item">
                  <div class="featured-product-link featured-product-placeholder">
                    <div class="featured-product-image featured-product-image-placeholder">
                      <span class="placeholder-icon">📦</span>
                    </div>
                    <div class="featured-product-name featured-product-name-placeholder">
                      Ürün Eklenecek
                    </div>
                  </div>
                </div>
              {% endfor %}
            {% endif %}
          </div>
        </div>
      </div>
    </section>

    <!-- ============ SHOP BY CATEGORY ============ -->
    <section class="section section--categories">
      <div class="container">
        <div class="section__head">
          <h2>Kategoriler</h2>
          <p>İhtiyacınıza uygun kategoriyi seçin ve geniş ürün yelpazemizi keşfedin</p>
        </div>

        <div class="categories-grid" role="list">
          {% if categories_with_mapping %}
            {% for cat_data in categories_with_mapping %}
              {% with category=cat_data.category mapping=cat_data.mapping %}
                {% if mapping.use_media_image and category.image %}
                  {% if forloop.counter == 1 %}
                    <!-- İlk satır: Sol büyük kategori -->
                    <a class="cat cat--large cat--row1-left {{ mapping.css_class }}" role="listitem" href="{% url 'core:category_detail' category.slug %}" style="background-image: url('{{ category.image.url }}');">
                      <span class="cat__overlay"></span>
                      <span class="cat__name">{{ category.name }}</span>
                    </a>
                  {% elif forloop.counter == 2 or forloop.counter == 3 %}
                    <!-- İlk satır: Sağ küçük kategoriler -->
                    <a class="cat cat--small {{ mapping.css_class }}" role="listitem" href="{% url 'core:category_detail' category.slug %}" style="background-image: url('{{ category.image.url }}');">
                      <span class="cat__overlay"></span>
                      <span class="cat__name">{{ category.name }}</span>
                    </a>
                  {% elif forloop.counter == 4 or forloop.counter == 5 %}
                    <!-- İkinci satır: Sol küçük kategoriler -->
                    <a class="cat cat--small {{ mapping.css_class }}" role="listitem" href="{% url 'core:category_detail' category.slug %}" style="background-image: url('{{ category.image.url }}');">
                      <span class="cat__overlay"></span>
                      <span class="cat__name">{{ category.name }}</span>
                    </a>
                  {% elif forloop.counter == 6 %}
                    <!-- İkinci satır: Sağ büyük kategori -->
                    <a class="cat cat--large cat--row2-right {{ mapping.css_class }}" role="listitem" href="{% url 'core:category_detail' category.slug %}" style="background-image: url('{{ category.image.url }}');">
                      <span class="cat__overlay"></span>
                      <span class="cat__name">{{ category.name }}</span>
                    </a>
                  {% else %}
                    <!-- Ekstra kategoriler varsa küçük olarak ekle -->
                    <a class="cat cat--small {{ mapping.css_class }}" role="listitem" href="{% url 'core:category_detail' category.slug %}" style="background-image: url('{{ category.image.url }}');">
                      <span class="cat__overlay"></span>
                      <span class="cat__name">{{ category.name }}</span>
                    </a>
                  {% endif %}
                {% else %}
                  {% if forloop.counter == 1 %}
                    <!-- İlk satır: Sol büyük kategori -->
                    <a class="cat cat--large cat--row1-left {{ mapping.css_class }}" role="listitem" href="{% url 'core:category_detail' category.slug %}" style="background-image: url('{% static 'images/categories/'|add:mapping.image %}');">
                      <span class="cat__overlay"></span>
                      <span class="cat__name">{{ category.name }}</span>
                    </a>
                  {% elif forloop.counter == 2 or forloop.counter == 3 %}
                    <!-- İlk satır: Sağ küçük kategoriler -->
                    <a class="cat cat--small {{ mapping.css_class }}" role="listitem" href="{% url 'core:category_detail' category.slug %}" style="background-image: url('{% static 'images/categories/'|add:mapping.image %}');">
                      <span class="cat__overlay"></span>
                      <span class="cat__name">{{ category.name }}</span>
                    </a>
                  {% elif forloop.counter == 4 or forloop.counter == 5 %}
                    <!-- İkinci satır: Sol küçük kategoriler -->
                    <a class="cat cat--small {{ mapping.css_class }}" role="listitem" href="{% url 'core:category_detail' category.slug %}" style="background-image: url('{% static 'images/categories/'|add:mapping.image %}');">
                      <span class="cat__overlay"></span>
                      <span class="cat__name">{{ category.name }}</span>
                    </a>
                  {% elif forloop.counter == 6 %}
                    <!-- İkinci satır: Sağ büyük kategori -->
                    <a class="cat cat--large cat--row2-right {{ mapping.css_class }}" role="listitem" href="{% url 'core:category_detail' category.slug %}" style="background-image: url('{% static 'images/categories/'|add:mapping.image %}');">
                      <span class="cat__overlay"></span>
                      <span class="cat__name">{{ category.name }}</span>
                    </a>
                  {% else %}
                    <!-- Ekstra kategoriler varsa küçük olarak ekle -->
                    <a class="cat cat--small {{ mapping.css_class }}" role="listitem" href="{% url 'core:category_detail' category.slug %}" style="background-image: url('{% static 'images/categories/'|add:mapping.image %}');">
                      <span class="cat__overlay"></span>
                      <span class="cat__name">{{ category.name }}</span>
                    </a>
                  {% endif %}
                {% endif %}
              {% endwith %}
            {% endfor %}
          {% else %}
            <!-- Fallback kategoriler -->
            <a class="cat cat--large cat--row1-left cat--racing" role="listitem" href="{% url 'core:category_list' %}" style="background-image: url('{% static 'images/categories/kosum-takimi.jpg' %}');">
              <span class="cat__overlay"></span>
              <span class="cat__name">At Koşu Ekipmanları</span>
            </a>
            <a class="cat cat--small cat--grooming" role="listitem" href="{% url 'core:category_list' %}" style="background-image: url('{% static 'images/categories/timar.jpg' %}');">
              <span class="cat__overlay"></span>
              <span class="cat__name">Tımar Ekipmanları</span>
            </a>
            <a class="cat cat--small cat--care" role="listitem" href="{% url 'core:category_list' %}" style="background-image: url('{% static 'images/categories/bakim.jpg' %}');">
              <span class="cat__overlay"></span>
              <span class="cat__name">At Bakım Ekipmanları</span>
            </a>
            <a class="cat cat--small cat--farrier" role="listitem" href="{% url 'core:category_list' %}" style="background-image: url('{% static 'images/categories/nalbant.jpg' %}');">
              <span class="cat__overlay"></span>
              <span class="cat__name">Nalbant Ekipmanları</span>
            </a>
            <a class="cat cat--small cat--rider" role="listitem" href="{% url 'core:category_list' %}" style="background-image: url('{% static 'images/categories/binici.jpg' %}');">
              <span class="cat__overlay"></span>
              <span class="cat__name">Binici Ekipmanları</span>
            </a>
            <a class="cat cat--large cat--row2-right cat--carriage" role="listitem" href="{% url 'core:category_list' %}" style="background-image: url('{% static 'images/categories/eyer.jpg' %}');">
              <span class="cat__overlay"></span>
              <span class="cat__name">Araba ve Fayton Takımı</span>
            </a>
          {% endif %}
        </div>
      </div>
    </section>

    <!-- ============ CATEGORY PRODUCTS ============ -->
    {% if categories_with_mapping %}
      {% for cat_data in categories_with_mapping %}
        {% with category=cat_data.category mapping=cat_data.mapping %}
          {% if category_with_products %}
            {% for category_name, products in category_with_products.items %}
              {% if category_name == category.name %}
                {% if products %}
                  <section class="section section--category-products">
                    <div class="container">
                      <div class="category-products__header">
                        <h3 class="category-products__title">{{ category.name }}</h3>
                        <a href="{% url 'core:category_detail' category.slug %}" class="category-products__link">Tümünü Gör →</a>
                      </div>
                      <div class="grid grid--category-products" role="list">
                        {% for product in products|slice:":8" %}
                          <article class="category-product" role="listitem">
                            <a class="category-product__media" href="{% url 'core:product_detail' product_name=product.name|urlencode %}">
                              <div class="category-product__img" style="background-image: url('{% static product.path %}'); background-size: cover; background-position: center;"></div>
                            </a>
                            <div class="category-product__meta">
                              <h4 class="category-product__title">
                                <a href="{% url 'core:product_detail' product_name=product.name|urlencode %}">
                                  {% if "." in product.name %}
                                    {% with name=product.name|slice:":-4" %}
                                      {{ name|title }}
                                    {% endwith %}
                                  {% else %}
                                    {{ product.name|title }}
                                  {% endif %}
                                </a>
                              </h4>
                            </div>
                          </article>
                        {% endfor %}
                      </div>
                    </div>
                  </section>
                {% endif %}
              {% endif %}
            {% endfor %}
          {% endif %}
        {% endwith %}
      {% endfor %}
    {% endif %}

  </main>
{% endblock %}

{% block extra_scripts %}
  <!-- Carousel Script -->
  <script>
    let nextButton = document.getElementById('next');
    let prevButton = document.getElementById('prev');
    let carousel = document.querySelector('.carousel');
    let listHTML = document.querySelector('.carousel .list');
    
    // Aktif model-viewer'a camera-controls ve auto-rotate ekle, diğerlerinden kaldır
    function updateCameraControls() {
      let items = document.querySelectorAll('.carousel .list .item');
      items.forEach((item, index) => {
        let modelViewer = item.querySelector('model-viewer');
        if (modelViewer) {
          // Sadece 2. child (aktif podyumdaki) için camera-controls ve auto-rotate olsun
          if (index === 1) {
            modelViewer.setAttribute('camera-controls', '');
            modelViewer.setAttribute('auto-rotate', '');
            // Model etkileşimini aktif et
            modelViewer.style.pointerEvents = 'auto';
            if (modelViewer.shadowRoot) {
              let userInput = modelViewer.shadowRoot.querySelector('.userInput');
              if (userInput) {
                userInput.style.pointerEvents = 'auto';
              }
              let canvas = modelViewer.shadowRoot.querySelector('canvas');
              if (canvas) {
                canvas.style.pointerEvents = 'auto';
              }
            }
          } else {
            // Diğer modeller için etkileşimi kapat ama model-viewer'ı görünür tut
            modelViewer.removeAttribute('camera-controls');
            modelViewer.removeAttribute('auto-rotate');
            modelViewer.style.pointerEvents = 'none';
          }
        }
      });
    }
    
    nextButton.onclick = function(){
        showSlider('next');
    }
    prevButton.onclick = function(){
        showSlider('prev');
    }
    let unAcceppClick;
    let autoSlideInterval;
    
    const showSlider = (type) => {
        nextButton.style.pointerEvents = 'none';
        prevButton.style.pointerEvents = 'none';

        carousel.classList.remove('next', 'prev');
        let items = document.querySelectorAll('.carousel .list .item');
        if(type === 'next'){
            listHTML.appendChild(items[0]);
            carousel.classList.add('next');
        }else{
            listHTML.prepend(items[items.length - 1]);
            carousel.classList.add('prev');
        }
        clearTimeout(unAcceppClick);
        unAcceppClick = setTimeout(()=>{
            nextButton.style.pointerEvents = 'auto';
            prevButton.style.pointerEvents = 'auto';
            // Animasyon bittiğinde modelleri yeniden yükle
            preloadAllModels();
            // Camera-controls'u güncelle
            updateCameraControls();
            // Model-viewer event'lerini güncelle
            attachModelViewerEvents();
            // Otomatik geçişi yeniden başlat
            startAutoSlide();
        }, 2000)
    }
    
    // Otomatik geçiş fonksiyonu
    function startAutoSlide() {
        // Önceki interval'i temizle
        clearInterval(autoSlideInterval);
        // 5 saniyede bir otomatik geçiş yap (animasyon süresi + bekleme)
        autoSlideInterval = setInterval(() => {
            showSlider('next');
        }, 5000);
    }
    
    // Otomatik geçişi durdur
    function stopAutoSlide() {
        clearInterval(autoSlideInterval);
    }
    
    let isInteracting = false;
    let interactionTimeout;
    
    // Aktif model-viewer'a mouse event'leri ekle
    let currentModelViewer = null;
    function attachModelViewerEvents() {
        let items = document.querySelectorAll('.carousel .list .item');
        items.forEach((item, index) => {
            let modelViewer = item.querySelector('model-viewer');
            if (modelViewer && index === 1 && modelViewer !== currentModelViewer) {
                // Önceki model-viewer'ın event'lerini temizle
                if (currentModelViewer) {
                    currentModelViewer.removeEventListener('mouseenter', handleMouseEnter);
                    currentModelViewer.removeEventListener('pointerdown', handlePointerDown);
                    currentModelViewer.removeEventListener('pointermove', handlePointerMove);
                    currentModelViewer.removeEventListener('pointerup', handlePointerUp);
                    currentModelViewer.removeEventListener('mouseleave', handleMouseLeave);
                }
                
                currentModelViewer = modelViewer;
                
                // Model-viewer'ın shadow DOM'undaki elementleri aktif et
                setTimeout(() => {
                    if (modelViewer.shadowRoot) {
                        let userInput = modelViewer.shadowRoot.querySelector('.userInput');
                        let canvas = modelViewer.shadowRoot.querySelector('canvas');
                        let controls = modelViewer.shadowRoot.querySelector('.controls');
                        
                        if (userInput) {
                            userInput.style.pointerEvents = 'auto';
                            userInput.style.display = 'block';
                        }
                        if (canvas) {
                            canvas.style.pointerEvents = 'auto';
                            canvas.style.display = 'block';
                        }
                        if (controls) {
                            controls.style.pointerEvents = 'auto';
                        }
                    }
                }, 200);
                
                // Model üzerine mouse geldiğinde otomatik geçişi durdur
                modelViewer.addEventListener('mouseenter', handleMouseEnter);
                
                // Mouse down - kullanıcı modeli hareket ettirmeye başladı
                modelViewer.addEventListener('pointerdown', handlePointerDown);
                
                // Mouse move - kullanıcı modeli hareket ettiriyor
                modelViewer.addEventListener('pointermove', handlePointerMove);
                
                // Mouse up - kullanıcı modeli hareket ettirmeyi bıraktı
                modelViewer.addEventListener('pointerup', handlePointerUp);
                
                // Mouse ayrıldığında tekrar başlat (eğer etkileşim yoksa)
                modelViewer.addEventListener('mouseleave', handleMouseLeave);
            }
        });
    }
    
    // Event handler fonksiyonları
    function handleMouseEnter() {
        stopAutoSlide();
    }
    
    function handlePointerDown() {
        isInteracting = true;
        stopAutoSlide();
        clearTimeout(interactionTimeout);
    }
    
    function handlePointerMove() {
        if (isInteracting) {
            stopAutoSlide();
            clearTimeout(interactionTimeout);
        }
    }
    
    function handlePointerUp() {
        isInteracting = false;
        clearTimeout(interactionTimeout);
        // 2 saniye sonra tekrar başlat
        interactionTimeout = setTimeout(function() {
            if (!isInteracting) {
                startAutoSlide();
            }
        }, 2000);
    }
    
    function handleMouseLeave() {
        if (!isInteracting) {
            clearTimeout(interactionTimeout);
            interactionTimeout = setTimeout(function() {
                startAutoSlide();
            }, 1000);
        }
    }
    
    // Poster'ı gizle ve canvas'ı göster
    function hidePosterAndShowCanvas(modelViewer) {
      if (!modelViewer) return;
      
      // Model-viewer'ın kendisini görünür yap
      modelViewer.style.opacity = '1';
      modelViewer.style.visibility = 'visible';
      modelViewer.style.display = 'block';
      
      // Reveal'i zorla - model hemen görünsün
      if (modelViewer.loaded || modelViewer.readyState > 0) {
        modelViewer.removeAttribute('reveal');
        modelViewer.setAttribute('reveal', 'interaction');
        // Reveal'i tamamen kaldırıp modeli hemen göster
        setTimeout(() => {
          modelViewer.removeAttribute('reveal');
        }, 100);
      }
      
      if (!modelViewer.shadowRoot) {
        // Shadow DOM yüklenene kadar bekle
        setTimeout(() => hidePosterAndShowCanvas(modelViewer), 100);
        return;
      }
      
      // Tüm poster elementlerini bul ve gizle
      let posterSelectors = [
        '#default-poster',
        '.slot.poster',
        '.slot.poster.show',
        'button[id="default-poster"]',
        '[part="default-poster"]'
      ];
      
      posterSelectors.forEach(selector => {
        let elements = modelViewer.shadowRoot.querySelectorAll(selector);
        elements.forEach(el => {
          el.style.display = 'none';
          el.style.visibility = 'hidden';
          el.style.opacity = '0';
          el.style.pointerEvents = 'none';
          el.classList.remove('show');
          el.setAttribute('hidden', '');
        });
      });
      
      // Canvas'ı bul ve göster
      let canvas = modelViewer.shadowRoot.querySelector('canvas');
      if (canvas) {
        canvas.style.display = 'block';
        canvas.style.opacity = '1';
        canvas.style.visibility = 'visible';
        canvas.style.pointerEvents = 'auto';
        canvas.style.zIndex = '10';
        canvas.style.position = 'relative';
        canvas.removeAttribute('hidden');
        canvas.style.width = '100%';
        canvas.style.height = '100%';
      }
      
      // Canvas slot'u göster
      let canvasSlot = modelViewer.shadowRoot.querySelector('.slot.canvas');
      if (canvasSlot) {
        canvasSlot.style.display = 'block';
        canvasSlot.style.opacity = '1';
        canvasSlot.style.visibility = 'visible';
        canvasSlot.style.pointerEvents = 'auto';
        canvasSlot.classList.add('show');
      }
      
      // UserInput'u göster
      let userInput = modelViewer.shadowRoot.querySelector('.userInput');
      if (userInput) {
        userInput.style.display = 'block';
        userInput.style.opacity = '1';
        userInput.style.visibility = 'visible';
        userInput.style.pointerEvents = 'auto';
      }
      
      // Renderer'ı kontrol et
      let renderer = modelViewer.shadowRoot.querySelector('.renderer');
      if (renderer) {
        renderer.style.display = 'block';
        renderer.style.opacity = '1';
        renderer.style.visibility = 'visible';
      }
      
      // Tüm görselleri (img) gizle - bunlar poster olabilir
      let images = modelViewer.shadowRoot.querySelectorAll('img');
      images.forEach(img => {
        // Eğer poster değilse bırak
        if (!img.id || !img.id.includes('poster')) {
          return;
        }
        img.style.display = 'none';
        img.style.visibility = 'hidden';
        img.style.opacity = '0';
      });
    }
    
    // Model yükleme durumlarını sakla
    let modelStates = new Map();
    
    // Tüm model-viewer'ları yükle (görünmeyen olanlar için de)
    function preloadAllModels(forceReload = false) {
      let allModelViewers = document.querySelectorAll('.carousel .list .item model-viewer');
      allModelViewers.forEach(function(modelViewer, index) {
        // URL'yi kontrol et
        let src = modelViewer.getAttribute('src');
        if (!src) {
          console.warn('Model-viewer has no src attribute at index', index);
          return;
        }
        
        // Hatalı modelleri atla
        if (modelStates.has(src) && modelStates.get(src).error) {
          modelViewer.style.display = 'none';
          return;
        }
        
        // Model-viewer'ı görünür yap
        modelViewer.style.display = 'block';
        modelViewer.style.opacity = '1';
        modelViewer.style.visibility = 'visible';
        
        // Shadow DOM yüklenene kadar bekle
        function processModelViewer() {
          if (!modelViewer.shadowRoot) {
            setTimeout(processModelViewer, 100);
            return;
          }
          
          // Poster'ı hemen gizle
          hidePosterAndShowCanvas(modelViewer);
          
          // Eğer model zaten yüklenmişse ve force reload değilse, sadece görünürlüğü ayarla
          if (!forceReload && modelStates.has(src) && modelStates.get(src).loaded) {
            setTimeout(() => {
              hidePosterAndShowCanvas(modelViewer);
              updateCameraControls();
            }, 100);
            return;
          }
          
          // Model yüklendiğinde
          let loadHandler = function() {
            console.log('Model loaded successfully:', src);
            modelStates.set(src, { loaded: true, modelViewer: modelViewer });
            // Canvas'ı hemen göster
            setTimeout(() => {
              hidePosterAndShowCanvas(modelViewer);
              updateCameraControls();
            }, 100);
          };
          
          // Önceki event listener'ları temizle
          modelViewer.removeEventListener('load', loadHandler);
          modelViewer.addEventListener('load', loadHandler, { once: true });
          
          // Model-loaded event'i (3D model parse edildi)
          let modelLoadedHandler = function() {
            console.log('✅ Model successfully loaded and ready:', src);
            modelStates.set(src, { loaded: true, modelViewer: modelViewer });
            // Canvas'ı zorla göster
            hidePosterAndShowCanvas(modelViewer);
            // Birkaç kez daha kontrol et
            setTimeout(() => hidePosterAndShowCanvas(modelViewer), 200);
            setTimeout(() => hidePosterAndShowCanvas(modelViewer), 500);
            updateCameraControls();
          };
          
          modelViewer.removeEventListener('model-loaded', modelLoadedHandler);
          modelViewer.addEventListener('model-loaded', modelLoadedHandler, { once: true });
          
          // Progress event'i - model yüklenirken canvas'ı göster
          modelViewer.addEventListener('progress', function(evt) {
            if (evt.detail && evt.detail.totalProgress > 0.1) {
              hidePosterAndShowCanvas(modelViewer);
            }
          });
          
          // Model yüklenemediğinde hata yakalama
          let errorHandler = function(event) {
            console.error('❌ Model load error for:', src);
            modelStates.set(src, { loaded: false, error: true });
            
            // Hatalı modeli gizle
            modelViewer.style.display = 'none';
            modelViewer.style.visibility = 'hidden';
            modelViewer.style.opacity = '0';
            
            if (event.detail && event.detail.message) {
              console.error('Error message:', event.detail.message);
              if (event.detail.message.includes('RangeError') || event.detail.message.includes('Invalid typed array length')) {
                console.error('⚠️ Model file is too large or corrupted:', src);
              }
              if (event.detail.message.includes('CORS') || event.detail.message.includes('cross-origin')) {
                console.error('⚠️ CORS error detected! Check your R2 bucket CORS settings.');
              }
              if (event.detail.message.includes('SSL') || event.detail.message.includes('ERR_SSL_PROTOCOL_ERROR')) {
                console.error('⚠️ SSL error detected! Check your R2 bucket SSL settings.');
              }
              if (event.detail.message.includes('404') || event.detail.message.includes('not found') || event.detail.message.includes('Failed to fetch')) {
                console.error('⚠️ File not found or fetch failed! Check if the file exists in R2 bucket: ' + src);
              }
            }
          };
          
          modelViewer.removeEventListener('error', errorHandler);
          modelViewer.addEventListener('error', errorHandler, { once: true });
          
          // Global error handler - SSL ve fetch hatalarını yakala
          window.addEventListener('error', function(evt) {
            if (evt.message && (
              evt.message.includes('ERR_SSL_PROTOCOL_ERROR') || 
              evt.message.includes('Failed to fetch') ||
              evt.message.includes('RangeError') ||
              evt.message.includes('Invalid typed array length')
            )) {
              // Bu hataları yakala ama model-viewer'a bırak
              return;
            }
          }, true);
          
          // Model yükleme başladığında
          try {
            // Eğer model zaten yüklenmeye başlamışsa
            if (modelViewer.loaded) {
              modelStates.set(src, { loaded: true, modelViewer: modelViewer });
              hidePosterAndShowCanvas(modelViewer);
              updateCameraControls();
            }
          } catch (e) {
            console.warn('Error checking model state:', e);
          }
        }
        
        processModelViewer();
      });
    }
    
    // Model-viewer custom element tanımlı mı kontrol et
    function waitForModelViewer(callback, maxAttempts = 50) {
      if (customElements.get('model-viewer')) {
        callback();
      } else if (maxAttempts > 0) {
        setTimeout(() => waitForModelViewer(callback, maxAttempts - 1), 100);
      } else {
        console.warn('model-viewer custom element not found after waiting');
        callback(); // Yine de devam et
      }
    }
    
    // Periyodik olarak canvas'ı kontrol et ve göster
    function ensureCanvasVisible() {
      let allModelViewers = document.querySelectorAll('.carousel .list .item model-viewer');
      allModelViewers.forEach(function(modelViewer) {
        if (modelViewer && !modelStates.get(modelViewer.getAttribute('src'))?.error) {
          // Model yüklenmişse canvas'ı göster
          if (modelViewer.loaded || modelViewer.readyState > 0) {
            hidePosterAndShowCanvas(modelViewer);
          }
        }
      });
    }
    
    // Her 500ms'de bir canvas'ı kontrol et
    setInterval(ensureCanvasVisible, 500);
    
    // Sayfa yüklendiğinde ilk kurulum
    window.addEventListener('DOMContentLoaded', function() {
      waitForModelViewer(function() {
        // DOM tamamen hazır olana kadar bekle
        setTimeout(function() {
          updateCameraControls();
          attachModelViewerEvents();
          // Tüm modelleri ön yükle
          preloadAllModels();
          // İlk otomatik geçişi başlat
          startAutoSlide();
          // Canvas kontrolünü başlat
          ensureCanvasVisible();
        }, 100);
      });
    });
    
    // Kullanıcı manuel tıkladığında otomatik geçişi yeniden başlat
    nextButton.addEventListener('click', function() {
        startAutoSlide();
    });
    
    prevButton.addEventListener('click', function() {
        startAutoSlide();
    });
  </script>

  <!-- Featured Products Blur Script -->
  <script>
    function updateFeaturedProductsBlur() {
      const carousel = document.getElementById('featuredCarousel');
      if (!carousel) return;
      
      const items = carousel.querySelectorAll('.featured-product-item');
      const carouselRect = carousel.getBoundingClientRect();
      const carouselLeft = carouselRect.left;
      const carouselRight = carouselRect.right;
      const blurZone = 150; // Blur başlangıç mesafesi
      
      items.forEach(item => {
        const itemRect = item.getBoundingClientRect();
        const itemLeft = itemRect.left;
        const itemRight = itemRect.right;
        const itemCenter = itemLeft + (itemRect.width / 2);
        
        // Sol kenara yakınlık
        const distanceFromLeft = itemCenter - carouselLeft;
        // Sağ kenara yakınlık
        const distanceFromRight = carouselRight - itemCenter;
        
        let blurAmount = 0;
        let opacity = 1;
        
        if (distanceFromLeft < blurZone) {
          blurAmount = (blurZone - distanceFromLeft) / blurZone * 8;
          opacity = 0.3 + (distanceFromLeft / blurZone) * 0.7;
        } else if (distanceFromRight < blurZone) {
          blurAmount = (blurZone - distanceFromRight) / blurZone * 8;
          opacity = 0.3 + (distanceFromRight / blurZone) * 0.7;
        }
        
        const image = item.querySelector('.featured-product-image');
        if (image) {
          image.style.filter = `blur(${blurAmount}px)`;
          image.style.opacity = opacity;
        }
      });
    }
    
    // Scroll ve animasyon sırasında blur güncelle
    let blurUpdateInterval;
    
    function startBlurUpdates() {
      updateFeaturedProductsBlur();
      blurUpdateInterval = setInterval(updateFeaturedProductsBlur, 100);
    }
    
    function stopBlurUpdates() {
      if (blurUpdateInterval) {
        clearInterval(blurUpdateInterval);
      }
    }
    
    window.addEventListener('DOMContentLoaded', function() {
      startBlurUpdates();
      
      // Carousel hover durumunda da çalışsın
      const featuredCarousel = document.getElementById('featuredCarousel');
      if (featuredCarousel) {
        featuredCarousel.addEventListener('mouseenter', startBlurUpdates);
        featuredCarousel.addEventListener('mouseleave', startBlurUpdates);
      }
    });
  </script>
{% endblock %}
